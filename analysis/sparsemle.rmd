---
title: "Comparing PMcC's `sparsemle` and Matthew's `ashr`"
author: "Lei Sun"
date: "2019-01-16"
output:
  workflowr::wflow_html:
    code_folding: hide
---

## Introduction

This is a quick simulation to compare PMcC's `sparsemle` and Matthew's `ashr`. The observations are signals plus Gaussian noise, and the signals are 90\% zero.
$$
\begin{aligned}
z_j &\overset{\text{iid}}{\sim} N(\theta_j, 1)\\
\theta_j &\overset{\text{iid}}{\sim} g = 0.9\delta_0 + 0.1 g_1
\end{aligned}
$$

The quantities we are comparing for each $j = 1, \ldots, p$ are `lfpr` from `sparsemle` which is computed as
$$
\begin{aligned}
\text{lfpr}(z_j)=\frac{1-\rho}{1-\rho+\rho\zeta(z_j, d)},
\end{aligned}
$$
and `lfdr` from `ashr` which is
$$
\begin{aligned}
\text{lfdr}(z_j)=\text{Pr}(\theta_j = 0|z_j, \hat g)
\end{aligned}
$$

```{r, fig.show = 'hide'}
source("http://www.stat.uchicago.edu/~pmcc/courses/sparsity.R")
library(ashr)
```

## Unimodal signals

Here $g_1 = N(0, 3^2)$.

```{r}
set.seed(777)
theta <- sample(c(rep(0, 900), rnorm(100, 0, 3)))
z <- theta + rnorm(1000)
fit.sparsemle <- sparsemle(z)
fit.ashr <- ashr::ash(z, 1)
lfpr <- (1 - fit.sparsemle$rho) / (1 - fit.sparsemle$rho + fit.sparsemle$rho * zeta_ip(z))
hist(theta, xlab = expression(theta))
plot(lfpr, inactivity_rate(fit.sparsemle), xlab = "lfpr (Sparse MLE)", ylab = "inactivity rate (Sparse MLE)", main = "lfpr vs inactivity rate")
abline(0, 1, col = "blue", lty = 2)
plot(ashr::get_lfdr(fit.ashr), ashr::get_lfsr(fit.ashr), xlab = "lfdr (ashr)", ylab = "lfsr (ashr)", main = "lfdr vs lfsr")
abline(0, 1, col = "blue", lty = 2)
plot(lfpr, ashr::get_lfdr(fit.ashr), xlab = "lfpr (Sparse MLE)", ylab = "lfdr (ashr)", main = "lfpr vs lfdr")
abline(0, 1, col = "blue", lty = 2)
plot(lfpr, ashr::get_lfsr(fit.ashr), xlab = "lfpr (Sparse MLE)", ylab = "lfsr (ashr)", main = "lfpr vs lfsr")
abline(0, 1, col = "blue", lty = 2)
plot(inactivity_rate(fit.sparsemle), ashr::get_lfdr(fit.ashr), xlab = "inactivity rate (Sparse MLE)", ylab = "lfdr (ashr)", main = "inactivity rate vs lfdr")
abline(0, 1, col = "blue", lty = 2)
plot(inactivity_rate(fit.sparsemle), ashr::get_lfsr(fit.ashr), xlab = "inactivity rate (Sparse MLE)", ylab = "lfsr (ashr)", main = "inactivity rate vs lfsr")
abline(0, 1, col = "blue", lty = 2)
```

## Point-mass signals

Here $g_1 = \delta_3$, a point mass at $3$.

```{r}
set.seed(777)
theta <- sample(c(rep(0, 900), rep(3, 100)))
z <- theta + rnorm(1000)
fit.sparsemle <- sparsemle(z)
fit.ashr <- ashr::ash(z, 1)
lfpr <- (1 - fit.sparsemle$rho) / (1 - fit.sparsemle$rho + fit.sparsemle$rho * zeta_ip(z))
hist(theta, xlab = expression(theta))
plot(lfpr, inactivity_rate(fit.sparsemle), xlab = "lfpr (Sparse MLE)", ylab = "inactivity rate (Sparse MLE)", main = "lfpr vs inactivity rate")
abline(0, 1, col = "blue", lty = 2)
plot(ashr::get_lfdr(fit.ashr), ashr::get_lfsr(fit.ashr), xlab = "lfdr (ashr)", ylab = "lfsr (ashr)", main = "lfdr vs lfsr")
abline(0, 1, col = "blue", lty = 2)
plot(lfpr, ashr::get_lfdr(fit.ashr), xlab = "lfpr (Sparse MLE)", ylab = "lfdr (ashr)", main = "lfpr vs lfdr")
abline(0, 1, col = "blue", lty = 2)
plot(lfpr, ashr::get_lfsr(fit.ashr), xlab = "lfpr (Sparse MLE)", ylab = "lfsr (ashr)", main = "lfpr vs lfsr")
abline(0, 1, col = "blue", lty = 2)
plot(inactivity_rate(fit.sparsemle), ashr::get_lfdr(fit.ashr), xlab = "inactivity rate (Sparse MLE)", ylab = "lfdr (ashr)", main = "inactivity rate vs lfdr")
abline(0, 1, col = "blue", lty = 2)
plot(inactivity_rate(fit.sparsemle), ashr::get_lfsr(fit.ashr), xlab = "inactivity rate (Sparse MLE)", ylab = "lfsr (ashr)", main = "inactivity rate vs lfsr")
abline(0, 1, col = "blue", lty = 2)
```

## No exact null

We now make a small change to the setting: here $g = 0.9N(0, 0.5^2) + 0.1g_1$, i.e., no $\theta_j$ that is exactly zero.

### Unimodal signals

$g_1 = N(0, 3^2)$

```{r}
set.seed(777)
theta <- sample(c(rnorm(900, 0, 0.5), rnorm(100, 0, 3)))
z <- theta + rnorm(1000)
fit.sparsemle <- sparsemle(z)
fit.ashr <- ashr::ash(z, 1)
lfpr <- (1 - fit.sparsemle$rho) / (1 - fit.sparsemle$rho + fit.sparsemle$rho * zeta_ip(z))
hist(theta, xlab = expression(theta))
plot(lfpr, inactivity_rate(fit.sparsemle), xlab = "lfpr (Sparse MLE)", ylab = "inactivity rate (Sparse MLE)", main = "lfpr vs inactivity rate")
abline(0, 1, col = "blue", lty = 2)
plot(ashr::get_lfdr(fit.ashr), ashr::get_lfsr(fit.ashr), xlab = "lfdr (ashr)", ylab = "lfsr (ashr)", main = "lfdr vs lfsr")
abline(0, 1, col = "blue", lty = 2)
plot(lfpr, ashr::get_lfdr(fit.ashr), xlab = "lfpr (Sparse MLE)", ylab = "lfdr (ashr)", main = "lfpr vs lfdr")
abline(0, 1, col = "blue", lty = 2)
plot(lfpr, ashr::get_lfsr(fit.ashr), xlab = "lfpr (Sparse MLE)", ylab = "lfsr (ashr)", main = "lfpr vs lfsr")
abline(0, 1, col = "blue", lty = 2)
plot(inactivity_rate(fit.sparsemle), ashr::get_lfdr(fit.ashr), xlab = "inactivity rate (Sparse MLE)", ylab = "lfdr (ashr)", main = "inactivity rate vs lfdr")
abline(0, 1, col = "blue", lty = 2)
plot(inactivity_rate(fit.sparsemle), ashr::get_lfsr(fit.ashr), xlab = "inactivity rate (Sparse MLE)", ylab = "lfsr (ashr)", main = "inactivity rate vs lfsr")
abline(0, 1, col = "blue", lty = 2)
```

### Point-mass signals

```{r}
set.seed(777)
theta <- sample(c(rnorm(900, 0, 0.5), rep(3, 100)))
z <- theta + rnorm(1000)
fit.sparsemle <- sparsemle(z)
fit.ashr <- ashr::ash(z, 1)
lfpr <- (1 - fit.sparsemle$rho) / (1 - fit.sparsemle$rho + fit.sparsemle$rho * zeta_ip(z))
hist(theta, xlab = expression(theta))
plot(lfpr, inactivity_rate(fit.sparsemle), xlab = "lfpr (Sparse MLE)", ylab = "inactivity rate (Sparse MLE)", main = "lfpr vs inactivity rate")
abline(0, 1, col = "blue", lty = 2)
plot(ashr::get_lfdr(fit.ashr), ashr::get_lfsr(fit.ashr), xlab = "lfdr (ashr)", ylab = "lfsr (ashr)", main = "lfdr vs lfsr")
abline(0, 1, col = "blue", lty = 2)
plot(lfpr, ashr::get_lfdr(fit.ashr), xlab = "lfpr (Sparse MLE)", ylab = "lfdr (ashr)", main = "lfpr vs lfdr")
abline(0, 1, col = "blue", lty = 2)
plot(lfpr, ashr::get_lfsr(fit.ashr), xlab = "lfpr (Sparse MLE)", ylab = "lfsr (ashr)", main = "lfpr vs lfsr")
abline(0, 1, col = "blue", lty = 2)
plot(inactivity_rate(fit.sparsemle), ashr::get_lfdr(fit.ashr), xlab = "inactivity rate (Sparse MLE)", ylab = "lfdr (ashr)", main = "inactivity rate vs lfdr")
abline(0, 1, col = "blue", lty = 2)
plot(inactivity_rate(fit.sparsemle), ashr::get_lfsr(fit.ashr), xlab = "inactivity rate (Sparse MLE)", ylab = "lfsr (ashr)", main = "inactivity rate vs lfsr")
abline(0, 1, col = "blue", lty = 2)
```

## Fat-tailed signals

As suggested by PMcC, we now try this more sparse and more fat-tailed signal distribution:
$g = 0.95\delta_0 + 0.05 t_2$

```{r}
set.seed(777)
theta <- sample(c(rep(0, 950), rt(50, 2)))
z <- theta + rnorm(1000)
fit.sparsemle <- sparsemle(z)
fit.ashr <- ashr::ash(z, 1)
lfpr <- (1 - fit.sparsemle$rho) / (1 - fit.sparsemle$rho + fit.sparsemle$rho * zeta_ip(z))
hist(theta, xlab = expression(theta))
plot(lfpr, inactivity_rate(fit.sparsemle), xlab = "lfpr (Sparse MLE)", ylab = "inactivity rate (Sparse MLE)", main = "lfpr vs inactivity rate")
abline(0, 1, col = "blue", lty = 2)
plot(ashr::get_lfdr(fit.ashr), ashr::get_lfsr(fit.ashr), xlab = "lfdr (ashr)", ylab = "lfsr (ashr)", main = "lfdr vs lfsr")
abline(0, 1, col = "blue", lty = 2)
plot(lfpr, ashr::get_lfdr(fit.ashr), xlab = "lfpr (Sparse MLE)", ylab = "lfdr (ashr)", main = "lfpr vs lfdr")
abline(0, 1, col = "blue", lty = 2)
plot(lfpr, ashr::get_lfsr(fit.ashr), xlab = "lfpr (Sparse MLE)", ylab = "lfsr (ashr)", main = "lfpr vs lfsr")
abline(0, 1, col = "blue", lty = 2)
plot(inactivity_rate(fit.sparsemle), ashr::get_lfdr(fit.ashr), xlab = "inactivity rate (Sparse MLE)", ylab = "lfdr (ashr)", main = "inactivity rate vs lfdr")
abline(0, 1, col = "blue", lty = 2)
plot(inactivity_rate(fit.sparsemle), ashr::get_lfsr(fit.ashr), xlab = "inactivity rate (Sparse MLE)", ylab = "lfsr (ashr)", main = "inactivity rate vs lfsr")
abline(0, 1, col = "blue", lty = 2)
```

## Differing `lfdr` and `lfsr`

```{r}
set.seed(777)
theta <- sample(c(rep(0, 600), rnorm(200, -3, 1), rnorm(200, 3, 1)))
z <- theta + rnorm(1000)
fit.sparsemle <- sparsemle(z)
fit.ashr <- ashr::ash(z, 1)
lfpr <- (1 - fit.sparsemle$rho) / (1 - fit.sparsemle$rho + fit.sparsemle$rho * zeta_ip(z))
hist(theta, xlab = expression(theta))
plot(lfpr, inactivity_rate(fit.sparsemle), xlab = "lfpr (Sparse MLE)", ylab = "inactivity rate (Sparse MLE)", main = "lfpr vs inactivity rate")
abline(0, 1, col = "blue", lty = 2)
plot(ashr::get_lfdr(fit.ashr), ashr::get_lfsr(fit.ashr), xlab = "lfdr (ashr)", ylab = "lfsr (ashr)", main = "lfdr vs lfsr")
abline(0, 1, col = "blue", lty = 2)
plot(lfpr, ashr::get_lfdr(fit.ashr), xlab = "lfpr (Sparse MLE)", ylab = "lfdr (ashr)", main = "lfpr vs lfdr", xlim = c(0, 1), ylim = c(0, 1))
abline(0, 1, col = "blue", lty = 2)
plot(lfpr, ashr::get_lfsr(fit.ashr), xlab = "lfpr (Sparse MLE)", ylab = "lfsr (ashr)", main = "lfpr vs lfsr", xlim = c(0, 1), ylim = c(0, 1))
abline(0, 1, col = "blue", lty = 2)
plot(inactivity_rate(fit.sparsemle), ashr::get_lfdr(fit.ashr), xlab = "inactivity rate (Sparse MLE)", ylab = "lfdr (ashr)", main = "inactivity rate vs lfdr")
abline(0, 1, col = "blue", lty = 2)
plot(inactivity_rate(fit.sparsemle), ashr::get_lfsr(fit.ashr), xlab = "inactivity rate (Sparse MLE)", ylab = "lfsr (ashr)", main = "inactivity rate vs lfsr")
abline(0, 1, col = "blue", lty = 2)
```

## Remarks

`sparsemle` provides `lfpr` and `inactivity rate`, while `ashr` provides `lfdr` and `lfsr`. All four numbers are quantifying the extent to which an observation $Z_j$ is associated with a non-signal. Generally speaking, `inactivity rate` is more conservative than `lfpr`, which is more conservative (when it is small) than `lfdr` and `lfsr`. The difference between `inactivity rate` and `lfpr` could be notable in some simulation settings, while in all of our settings, `lfpr` is quite comparable to `lfdr` and `lfsr`, and `lfdr` and `lfsr` are essentially indistinguishable. Interestingly, `lfpr` and `lfdr` (`lfsr`) are most similar when we have unimodal signals and no exact nulls.
